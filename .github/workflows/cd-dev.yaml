name: CD - Deploy to Staging Server

on:
  workflow_run:
    workflows: ["CI - FastAPI Build Check"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Decode SSH Private Key
        run: |
            echo "${{ secrets.DEV_SERVER_KEY }}" | base64 -d > private_key
            chmod 600 private_key

      - name: Copy deploy script to server
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key ${{ secrets.DEV_SSH_USER }}@${{ secrets.DEV_SSH_HOST }} 'mkdir -p ~/ai-service/deploy'
          scp -o StrictHostKeyChecking=no -i private_key ./deploy-ai.sh ${{ secrets.DEV_SSH_USER }}@${{ secrets.DEV_SSH_HOST }}:~/ai-service/deploy/deploy-ai.sh
      

      - name: SSH Deploy Script Execution
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key ${{ secrets.DEV_SSH_USER }}@${{ secrets.DEV_SSH_HOST }} 'bash ~/ai-service/deploy/deploy-ai.sh'